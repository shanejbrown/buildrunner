name: Build
on:
  # Only run workflow when there is push to main or when there is a pull request to main
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  test:
    # When running with act (https://github.com/nektos/act), these lines need to be appended with the ACT variable
    # to force each job to run
    if: github.repository == 'adobe/buildrunner' #|| ${{ env.ACT }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version:
        - '3.9'
        - '3.10'
        - '3.11'
        - '3.12'
        - '3.13'
    steps:
    - uses: actions/checkout@v2
    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        python-version: ${{ matrix.python-version }}
    # Install dev dependencies
    - name: Install dependencies
      run: uv sync --locked
    - name: Pre-commit checks
      run: uv run pre-commit run --all-files

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1
      with:
        platforms: linux/amd64,linux/arm64

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Test with pytest
      # Create the ssh key file once for all testing
      run: |
        ssh-keygen -t ecdsa -m PEM -N '' -f /tmp/buildrunner-test-id_rsa
        uv run pytest -v -m "not serial" --numprocesses=auto --junitxml=test-reports/non-serial-test-results.xml
        uv run pytest -v -m "serial" --junitxml=test-reports/serial-test-results.xml
        uv run python scripts/combine_xml.py test-reports/serial-test-results.xml test-reports/non-serial-test-results.xml > test-reports/test-results.xml
    - name: Publish test results
      uses: EnricoMi/publish-unit-test-result-action/linux@v2
      if: always()
      with:
        files: test-reports/test-results.xml
        check_name: "Test Results ${{ matrix.python-version }}"
        github_retries: 10
        secondary_rate_limit_wait_seconds: 60.0
  # Version source of truth: pyproject.toml [project] version.
  # - Patch: CI bumps patch on every push to main (and commits it).
  # - Minor/major: Update version in pyproject.toml (e.g. uv version 3.22.0 or uv version --bump minor),
  #   merge with message "Release 3.22.0"; CI will use that version as-is and tag it.
  get-version:
    if: github.repository == 'adobe/buildrunner'
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: write
    outputs:
      current-version: ${{ steps.version-number.outputs.CURRENT_VERSION }}
      should-tag: ${{ steps.tag-decision.outputs.should_tag }}
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          python-version: 3.9
      - name: Install dependencies
        run: uv sync --locked
      - name: Bump version (patch only when not the botâ€™s bump commit)
        id: bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && !contains(github.event.head_commit.message, 'Bump version to')
        run: uv version --bump patch
      - name: Get current version
        id: version-number
        run: echo "CURRENT_VERSION=$(uv version --short)" >> $GITHUB_OUTPUT
      - name: Print current version
        run: echo CURRENT_VERSION ${{ steps.version-number.outputs.CURRENT_VERSION }}
      - name: Set tag/publish decision
        id: tag-decision
        run: |
          if [ "${{ steps.bump.outcome }}" = "success" ]; then echo "should_tag=true" >> $GITHUB_OUTPUT; exit 0; fi
          echo "should_tag=false" >> $GITHUB_OUTPUT
      - name: Print tag decision
        run: echo "should_tag=${{ steps.tag-decision.outputs.should_tag }}"
      - name: Commit and push version bump
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && !contains(github.event.head_commit.message, 'Bump version to')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml uv.lock
          git diff --staged --quiet || (git commit -m "Bump version to ${{ steps.version-number.outputs.CURRENT_VERSION }}" && git push)
  tag-commit:
    if: github.repository == 'adobe/buildrunner' && github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.get-version.outputs.should-tag == 'true'
    runs-on: ubuntu-latest
    needs: [test, get-version]
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: main
      - name: Tag commit
        run: git tag ${{ needs.get-version.outputs.current-version }} && git push --tags
  publish-pypi:
    if: github.repository == 'adobe/buildrunner' && (github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.get-version.outputs.should-tag == 'true'))
    runs-on: ubuntu-latest
    needs: [test, get-version]
    steps:
    - uses: actions/checkout@v2
      with:
        ref: ${{ github.ref == 'refs/heads/main' && 'main' || github.sha }}
    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        python-version: 3.9
    - name: Install dependencies
      run: uv sync --locked
    - name: Set version
      run: uv version --no-sync "${{ needs.get-version.outputs.current-version }}"
    - name: Build
      run: uv build
    - name: Check upload
      run: uv run --with twine twine check dist/*
    - name: Publish to PyPi
      uses: pypa/gh-action-pypi-publish@release/v1
      # Only publish on pushes to main
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      with:
        user: __token__
        password: ${{ secrets.ADOBE_BOT_PYPI_TOKEN }}
  publish-docker:
    if: github.repository == 'adobe/buildrunner' && (github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.get-version.outputs.should-tag == 'true'))
    runs-on: ubuntu-latest
    needs: [test, get-version]
    steps:
    - uses: actions/checkout@v2
      with:
        ref: ${{ github.ref == 'refs/heads/main' && 'main' || github.sha }}
    - name: Docker Tags
      id: docker_tags
      uses: docker/metadata-action@v3
      with:
        images: ghcr.io/adobe/buildrunner
        tags: |
          latest
          ${{ needs.get-version.outputs.current-version }}
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1
      with:
        platforms: linux/amd64,linux/arm64
    # Buildx is used to build multi-platform images
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1
    # Login to the docker registry
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v1
      # Only login if this a push to main
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build and Push Image
      uses: docker/build-push-action@v2
      with:
        context: .
        # Only push images if this is a push to main
        push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        platforms: linux/amd64,linux/arm64
        tags: ${{ steps.docker_tags.outputs.tags }}
        labels: ${{ steps.docker_tags.outputs.labels }}
